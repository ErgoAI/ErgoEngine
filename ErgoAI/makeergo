#! /bin/sh

if [ "$1" = clean ] ; then
    make clean
    exit 0
elif [ "$1" = veryclean ] ; then
    make veryclean
    exit 0
fi

touch flrincludes/flora_terms.flh

if [ -n "$1" -a "$1" != all -a "$1" != top -a "$1" != core -a "$1" != system -a "$1" != base -a "$1" != libs -a "$1" != misc -a "$1" != nodocs -a "$1" != manuals -a "$1" != version -a "$1" != "-P" -a "$1" != "-S" ] ; then
    echo ""
    echo +++++ Argument 1 must be a Makefile target such as all, top, core, etc.
    echo ""
    exit 1
fi

# if the first argument is -S, use subsumptive tabling
# if the first argument is -P, use nonincremental (passive) tabling
tabling_method="/* default tabling */"
if test "$1" = "-S"; then
    tabling_method="#define FLORA_SUBSUMPTIVE_TABLING"
    shift
fi
if test "$1" = "-P"; then
    tabling_method="#define FLORA_NONINCREMENTAL_TABLING"
    shift
fi
if test "$1" = "-S"; then
    tabling_method="#define FLORA_SUBSUMPTIVE_TABLING"
    shift
fi

# Arg 1 is a make target. One of: all (default), system, base, top

if [ -z "$2" ] ; then
    prologcmd=none
else
    prologcmd=$2
fi

./ergo_sanity_check.sh "$prologcmd" compiling || exit 1
# Set PROLOG to the absolute path that was generated by flrconfig.P
. ./.ergo_paths

default_tabling=flrincludes/.ergo_default_tabling
echo "$tabling_method" >  $default_tabling

chmod 755 ./runflora ./runflora*.bat

if [ -d /cygdrive/c  ]; then
    # It is CYGWIN
    rm -f cc/*.dll cc/*.lib cc/*.exp cc/*.obj cc/*.def cc/*.a cc/*.o
    rm -f cc/prolog2hilog.xwam
fi


touch flrincludes/flora_terms.flh flrincludes/flora_exceptions.flh

# touch to update version display
touch flrversion.P flora2.P
# if make fails, exit 1 so makeergo will know
make $1 PROLOG=$PROLOG && exit 1

chmod a+r * */*

